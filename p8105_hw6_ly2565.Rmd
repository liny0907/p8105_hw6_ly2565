---
title: "p8105_hw6_ly2565"
author: "Lin Yang"
date: "11/29/2021"
output: github_document
---

```{r, setup, include = FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
set.seed(1)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

### Load and clean the dataset for regression analysis
```{r, message = FALSE}
birthweight_df = 
  read_csv("data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(babysex = as.factor(babysex))

birthweight_df
```

### Check for missing values
```{r}
map(birthweight_df, ~sum(is.na(.)))
```
There are no missing values in the dataset. 

### Propose a regression model for birthweight


```{r}
model1 = lm(bwt ~fincome + delwt + momage + pnumlbw + smoken + wtgain, data = birthweight_df)

summary(model1)
broom::tidy(model1)
```

Make a plot of model residuals against fitted values.
```{r, warning = FALSE, dpi = 300}
birthweight_df %>% 
  add_predictions(model1) %>% 
  add_residuals(model1) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.3) +
  geom_smooth(color = "red", method = "lm", se = FALSE)
```

### Fit the other two models

* One using length at birth and gestational age as predictors (main effects only)
* One using head circumference, length, sex, and all interactions (including the three-way interaction) between these
```{r}
model2 = lm(bwt ~blength + gaweeks, data = birthweight_df)
summary(model2)
broom::tidy(model2)

model3 = lm(bwt ~bhead + blength + babysex + 
                 bhead * blength + bhead * babysex + blength * babysex +
                 bhead * blength * babysex, data = birthweight_df)
summary(model3)
broom::tidy(model3)
```

### Compare the three models in terms of cross validation
```{r, warning = FALSE}
cv_df =
  crossv_mc(birthweight_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)) %>% 
  mutate(
    model1 = map(train, ~lm(bwt ~ fincome + delwt + momage + pnumlbw + smoken + wtgain, data = .x)),
    model2 = map(train, ~lm(bwt ~blength + gaweeks, data = .x)),
    model3 = map(train, ~lm(bwt ~bhead + blength + babysex + 
                 bhead * blength + bhead * babysex + blength * babysex +
                 bhead * blength * babysex, data = .x))) %>% 
  mutate(
    rmse_model1 = map2_dbl(model1, test, ~rmse(model = .x, data = .y)),
    rmse_model2 = map2_dbl(model2, test, ~rmse(model = .x, data = .y)),
    rmse_model3 = map2_dbl(model3, test, ~rmse(model = .x, data = .y)))

cv_df 
```

Make a boxplot showing rmse distribution across 3 models.
```{r, dpi = 300}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_boxplot()
```
The boxplot indicates that model3 has the lowest prediction error distribution, and model1 has the highest one. This suggests that model3 is the best fit for birthweight among the three models. 

## Problem 2

### Load the 2017 Central Park weather data

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())

weather_df
```


Draw 5000 bootstrap samples.
```{r}
boot_strap_df = 
  weather_df %>% 
  bootstrap(n = 5000)

boot_strap_df
```

```{r}
r_squared_results = 
  boot_strap_df %>% 
  mutate(
    models = map(strap, ~lm(tmax ~ tmin, data = .x)),
    results = map(models, broom::glance)) %>%
  select(-strap, -models) %>% 
  unnest(results)

r_squared_results %>% 
  ggplot(aes(x = adj.r.squared)) +
  geom_density()

r_squared_results %>% 
  summarize(
    ci_lower = quantile(r.squared, 0.025),
    ci_upper = quantile(r.squared, 0.975)) %>% 
  knitr::kable()
```

```{r}
log_results = 
  boot_strap_df %>% 
  mutate(
    models = map(strap, ~lm(tmax ~ tmin, data = .x)),
    results = map(models, broom::tidy)) %>%
  select(-strap, -models) %>% 
  unnest(results)

beta_0 = 
  log_results %>% 
  filter(term == "(Intercept)") %>% 
  rename(beta_0_est = estimate)

beta_1 = 
  log_results %>% 
  filter(term == "tmin") %>% 
  rename(beta_1_est = estimate)

df = 
  left_join(beta_0, beta_1, by = ".id") %>% 
  select(.id, beta_0_est, beta_1_est) %>% 
  mutate(log = log(beta_0_est * beta_1_est)) %>% 
  ggplot(aes(x = log)) +
  geom_density()

  
```



